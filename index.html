<!DOCTYPE html>
<html lang="en">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamGuide</title>
    <style>
        :root { --bg: #131314; --card: #1e1f20; --text: #e3e3e3; --accent: #8ab4f8; --input-bg: #28292a; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 260px; background: #000; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #333; }
        .tier-card { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; font-size: 14px; }
        .limit-box { margin-top: auto; padding: 10px; background: #28292a; border-radius: 8px; font-size: 12px; text-align: center; }
        .progress-bar { height: 8px; background: #444; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* Main Area */
        #main { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        #app { display: flex; flex-direction: column; width: 100%; max-width: 700px; height: 100%; padding: 20px; box-sizing: border-box; }
        #messages { flex: 1; overflow-y: auto; padding: 20px 0; display: flex; flex-direction: column; gap: 20px; }
        .msg { line-height: 1.6; max-width: 85%; padding: 12px 18px; border-radius: 18px; }
        .user-msg { align-self: flex-end; background: var(--input-bg); }
        .bot-msg { align-self: flex-start; border-left: 2px solid #444; }
        
        /* Input & Controls */
        .input-container { display: flex; gap: 10px; background: var(--input-bg); padding: 10px; border-radius: 25px; margin-bottom: 20px; }
        input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--accent); font-size: 18px; }
        
        /* Popups */
        #paywall { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #legalModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:300; overflow-y:auto; padding:40px; }
        .legal-content { background:var(--card); color:var(--text); padding:30px; border-radius:15px; max-width:800px; margin:auto; text-align:left; font-size:14px; }
        .footer-links { color: #555; font-size: 10px; cursor: pointer; text-decoration: underline; margin-top: 5px; display: block; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2 style="color: var(--accent);">FamGuide</h2>
        <div class="tier-card" id="pro-status">
            <strong id="tier-name">Free Version</strong>
            <p id="tier-desc" style="color:#888; font-size: 12px;">10 questions per day.</p>
            <button id="upgrade-btn" onclick="window.open('https://buy.stripe.com/YOUR_LINK_HERE', '_blank')" style="width:100%; background:gold; border:none; padding:8px; border-radius:5px; cursor:pointer; font-weight:bold; color:black;">Upgrade to Pro</button>
        </div>
        
        <div class="limit-box" id="limit-container">
            <span id="limit-text">Questions today: 0 / 10</span>
            <div class="progress-bar"><div id="progress-fill"></div></div>
        </div>
        
        <span class="footer-links" onclick="unlockPro()">Enter Pro Code</span>
        <span class="footer-links" onclick="openLegal()">Privacy & CCPA Terms</span>
    </div>

    <div id="main">
        <div id="paywall">
            <div style="background:var(--card); padding:40px; border-radius:24px; max-width:400px;">
                <h2>Daily Limit Reached</h2>
                <p>You have used your 10 free questions. Upgrade to FamGuide Pro for unlimited expert access.</p>
                <button onclick="window.open('https://buy.stripe.com/YOUR_LINK_HERE', '_blank')" style="background:gold; border:none; padding:12px 24px; border-radius:20px; cursor:pointer; font-weight:bold; color:black;">Get Pro Now</button>
            </div>
        </div>

        <div id="app">
            <div id="messages">
                <div class="bot-msg msg">Hi, I am FamGuide. I offer advice based on experts like Dr. Becky and Dr. Gabor Mate. How can I help your family today?</div>
            </div>
            <div class="input-container">
                <button class="icon-btn" onclick="startVoice()">ðŸŽ¤</button>
                <input type="text" id="userInput" placeholder="Ask FamGuide...">
                <button class="icon-btn" onclick="send()">âž”</button>
            </div>
        </div>
    </div>

    <div id="legalModal">
        <div class="legal-content">
            <button onclick="closeLegal()" style="float:right; background:none; border:none; color:var(--accent); cursor:pointer;">Close [X]</button>
            <h1>Privacy Policy & Terms</h1>
            <p><strong>Last Updated: January 2026</strong></p>
            <h3>CCPA Rights</h3>
            <p>California residents have the right to request deletion of data. FamGuide does not sell your data. All chat data is stored locally in your browser cache.</p>
            <h3>Disclaimer</h3>
            <p>FamGuide is for educational purposes only. It is not medical advice or therapy. If you are in crisis, please contact emergency services immediately.</p>
            <button onclick="closeLegal()" style="background:var(--accent); border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:bold;">I Agree</button>
        </div>
    </div>

    <script>
        const DAILY_LIMIT = 10;
        const SECRET_CODE = "FAMPRO2026"; 

        function isPro() { return localStorage.getItem('famguide_pro') === 'true'; }
        
        function getUsage() {
            const today = new Date().toLocaleDateString();
            const data = JSON.parse(localStorage.getItem('usage_stats') || '{}');
            if (data.date !== today) return { date: today, count: 0 };
            return data;
        }

        function updateUI() {
            if (isPro()) {
                document.getElementById('tier-name').innerText = "FamGuide Pro";
                document.getElementById('tier-desc').innerText = "Unlimited Access Active";
                document.getElementById('upgrade-btn').style.display = 'none';
                document.getElementById('limit-container').style.display = 'none';
                document.getElementById('paywall').style.display = 'none';
                return;
            }
            const usage = getUsage();
            document.getElementById('limit-text').innerText = `Questions today: ${usage.count} / ${DAILY_LIMIT}`;
            document.getElementById('progress-fill').style.width = (usage.count / DAILY_LIMIT * 100) + '%';
            if (usage.count >= DAILY_LIMIT) document.getElementById('paywall').style.display = 'flex';
        }

        async function send() {
            const usage = getUsage();
            if (!isPro() && usage.count >= DAILY_LIMIT) return;

            const input = document.getElementById('userInput');
            const msgDiv = document.getElementById('messages');
            if (!input.value) return;

            const prompt = input.value;
            msgDiv.innerHTML += `<div class="user-msg msg">${prompt}</div>`;
            input.value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });
                const data = await response.json();
                msgDiv.innerHTML += `<div class="bot-msg msg">${data.text}</div>`;
                
                if (!isPro()) {
                    usage.count++;
                    localStorage.setItem('usage_stats', JSON.stringify(usage));
                    updateUI();
                }
                msgDiv.scrollTop = msgDiv.scrollHeight;
            } catch (e) {
                msgDiv.innerHTML += `<div class="bot-msg msg">Connection error. Please check your internet.</div>`;
            }
        }

        function startVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("Voice not supported in this browser.");
            const recognition = new SpeechRecognition();
            recognition.onresult = (e) => { document.getElementById('userInput').value = e.results[0][0].transcript; };
            recognition.start();
        }

        function unlockPro() {
            if (prompt("Enter Pro Activation Code:") === SECRET_CODE) {
                localStorage.setItem('famguide_pro', 'true');
                updateUI();
                alert("Pro Unlocked!");
            }
        }

        function openLegal() { document.getElementById('legalModal').style.display = 'block'; }
        function closeLegal() { document.getElementById('legalModal').style.display = 'none'; }
        
        window.onload = updateUI;
    </script>
</body>
</html>

